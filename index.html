<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- IBM Plex Sans (match Preview Template) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
/* =========================================================
   ESCAMILLA TOOLS UI v1 â€” MATCH PREVIEW TEMPLATE
   IMPORTANT: Print layout remains controlled by your existing
   inch-based layout rules and @media print.
   ========================================================= */

/* IBM Plex Sans (headers + labels) */
#day,
.section-title,
.brand .addr,
.label{
  font-family: var(--sans);
}

@page{
  size: A5;
  margin: 0;
}

:root{

  
    /* Default button tokens */
    --btn-bg: #6b7280;
    --btn-color: #fff;
    --btn-border: #6b7280;
    --btn-radius: 10px;
    --btn-padding: 12px 24px;
    --btn-font-weight: 600;
    --btn-shadow: 0 1px 4px rgba(0,0,0,0.08);
    --btn-hover-shadow: 0 2px 8px rgba(0,0,0,0.12);
    --btn-hover-color: #fff;
    --btn-hover-bg: #4b5563;
    --btn-hover-border: #4b5563;
  /* ===== Your existing print tokens (DO NOT CHANGE) ===== */
  --ink:#111;
  --rule:#222;
  --sans: 'Motiva Sans', Arial, Helvetica, sans-serif;
  --side-gap: 12px;      /* âœ… adjust this to move BUS/DRIVERS closer/farther */
  --side-width: 200px;   /* width of BUS / DRIVERS columns */
  --outer-pad: 10px;     /* padding around the whole layout */

  /* single unified line weight */
  --border: 1px;

  --pad: 0.16in;
  --panel-pad: 0.10in;
  --footer-safe: 0in;


  --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "IBM Plex Sans", Arial, Helvetica, sans-serif;
  --mono: -apple-system, BlinkMacSystemFont, "Segoe UI", "IBM Plex Sans", Arial, Helvetica, sans-serif;

  --label-size: 0.105in;
  --tiny-size: 0.096in;
  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "IBM Plex Sans", Arial, Helvetica, sans-serif;

  --underline: 1px dotted rgba(0,0,0,.35);

  --pickup:#E0442E;
  --exp-row-h: 0.34in;
  --notes-h: 0.30in;

  --section-gap: 0.06in;

  /* ===== Escamilla Tools UI v1 (SCREEN TOKENS â€” match Preview) ===== */
  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "IBM Plex Sans", Arial, Helvetica, sans-serif;

  --fs-xxs: 10px;
  --fs-xs:  11px;
  --fs-sm:  14px;   /* Base body text */
  --fs-md:  16px;   /* Section headers, buttons */
  --fs-lg:  18px;   /* Tool title */

  --fw-regular: 400;
  --fw-medium:  600;
  --fw-bold:    700;
  --fw-black:   900;

  --s-1: 4px;
  --s-2: 8px;
  --s-3: 12px;
  --s-4: 16px;
  --s-5: 24px;

  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;

  --bg: #eef1f5;
  --card: #ffffff;
  --text: #111827;
  --muted: #6b7280;

  --ui-border: #d9dde3;
  --ui-border-strong: #9aa3ad;

  --app-max: 1600px;
    --btn-default-bg: #fff;
  --btn-default-bg2: #fff;
  --btn-default-border: #e7ebf0;
  --btn-default-text: #333;
  --btn-default-hover-bg: #e6e6e6;
  --btn-default-hover-bg2: #e6e6e6;

  /* ------------------------------- [PRIMARY BUTTON TOKENS] */

  --btn-primary-bg: #333;
  --btn-primary-bg2: #333;
  --btn-primary-border: #333;
  --btn-primary-text: #fff;
  --btn-primary-hover-bg: #1a1a1a;
  --btn-primary-hover-bg2: #1a1a1a;

  /* -------------------------------- [DANGER BUTTON TOKENS] */

  --btn-danger-bg: #c62828;
  --btn-danger-bg2: #c62828;
  --btn-danger-border: #c62828;
  --btn-danger-text: #fff;
  --btn-danger-hover-bg: #8a1c1c;
  --btn-danger-hover-bg2: #8a1c1c;
}

*{ box-sizing:border-box; }
html, body{ height:100%; }

body{
  margin:0;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-family);
  font-size: var(--fs-sm); /* 14px base */
  font-weight: var(--w-regular);
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Match Preview Template helpers */
.screen-only{ display:block; }
.print-only{ display:none; }

.app{
  max-width: var(--app-max);
}

/* sample-filled text should look normal (not placeholder blue) */
.sample-fill{
  color: var(--ink);
  font-style: normal;
  letter-spacing: normal;
}

/* ---------- STANDARD TOOL HEADER (match Preview) ---------- */
.tool-header{
  background: var(--card);
  border: 1px solid #e3e6eb;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: var(--s-3) var(--s-4);
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: var(--s-4);
  margin: var(--s-3);
}

.tool-brand{
  display:flex;
  align-items:center;
  gap: var(--s-2);
  white-space:nowrap;
}
.tool-logo{
  height: 28px;
  width:auto;
}

.tool-title{
  display:flex;
  flex-direction:column;
  line-height:1.15;
}
.tool-title .name{
  font-size: 24px; /* match Preview Template */
  font-weight: var(--w-regular);
  color: var(--text);
}

.tool-actions {
  display: flex;
  gap: var(--s-2);
  justify-content: center;
  flex-wrap: wrap;
}

/* --------------------------------------- [DEFAULT BUTTONS] */

.button-default {
  background: linear-gradient(var(--btn-default-bg), var(--btn-default-bg2));
  border: 1.5px solid var(--btn-default-border);
  color: var(--btn-default-text);
  text-decoration: none;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-soft);
  cursor: pointer;
  font-family: var(--font);
  font-size: var(--fs-sm);
  font-weight: var(--fw-bold);
  padding: var(--s-2) var(--s-3);
  transition: background 120ms, border-color 120ms, transform 80ms;
  white-space: nowrap;
}

.button-default:hover {
  background: linear-gradient(var(--btn-default-hover-bg), var(--btn-default-hover-bg2));
  border-color: var(--btn-default-border);
}

.button-default.toggleBtn.active {
  background: linear-gradient(var(--btn-primary-bg), var(--btn-primary-bg2));
  border: 1.5px solid var(--btn-primary-border);
  color: var(--btn-primary-text);
}

/* ---------------------------------------- [PRIMARY BUTTON] */

.button-default.primary {
  background: linear-gradient(var(--btn-primary-bg), var(--btn-primary-bg2));
  border: 1.5px solid var(--btn-primary-border);
  color: var(--btn-primary-text);
}

.button-default.primary:hover {
  background: linear-gradient(var(--btn-primary-hover-bg), var(--btn-primary-hover-bg2));
  border-color: var(--btn-primary-border);
}

/* ---------------------------------------- [DANGER BUTTONS] */

.button-default.danger {
  background: linear-gradient(var(--btn-danger-bg), var(--btn-danger-bg2));
  border: 1.5px solid var(--btn-danger-border);
  color: var(--btn-danger-text);
}

.button-default.danger:hover {
  background: linear-gradient(var(--btn-danger-hover-bg), var(--btn-danger-hover-bg2));
  border-color: var(--btn-danger-border);
}


.button-default:active {
  transform: translateY(1px);
}

.button-default:focus {
  outline: none;
  box-shadow: 0 0 0 3px var(--focus), 0 1px 0 rgba(16,24,40,0.03);
  border-color: #7aa0ff;
}

/* ---------- Controls (screen-only, match Preview inset) ---------- */
.controls{
  display:block;
  margin: var(--s-3)

  padding: 0;
}

/* ---------- Quick Actions Sections (Autofill / Trip Date) ---------- */
.quick-actions-section{
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
}

/* Quick Actions labels â€” match BUSES/DRIVERS side titles */
.quick-actions-label{
  font-family: var(--font-family);
  font-weight: var(--w-black);
  font-size: var(--fs-xs);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  text-align: center;
  color: #111;
}

/* ---------- Quick Actions (Autofill + Date buttons container) ---------- */

.btn-row {
  display: flex;
  gap: var(--s-2);
  justify-content: center;
  flex-wrap: wrap;
}

.quick-actions-box{
  width: auto;
  margin: var(--s-3);
  padding: var(--s-3);
  display: flex;
  flex-direction: column;
  gap: var(--s-2);
  background: var(--card);
  border: 1px solid #e3e6eb;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-soft);
}

/* status line (kept, just styled) */
.controls-meta{
  font-size: var(--fs-xs);
  letter-spacing: 0.10em;
  text-transform: uppercase;
  color: var(--muted);
  margin: 0 0 var(--s-2);
  text-align:center;
}

.controls-buttons{
  display:flex;
  flex-direction:column;
  gap: var(--s-2);
  align-items:center;
}

.controls-buttons .btn-row{
  display:flex;
  gap: var(--s-3);
  justify-content:center;
  flex-wrap:wrap;
}

/* Each labeled group inside the quick actions box */
.quick-actions-group{
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* ---------- Layout (screen framing) ---------- */
.layout{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  gap: var(--side-gap);

  /* ðŸ”’ lock layout to the SAME frame as Autofill */
  width: var(--frame-width);
  max-width: var(--frame-width);

  margin: 0 auto;

  /* Only bottom padding, no left/right, so gap is exactly 12px */
  padding: 0 0 var(--outer-pad) 0;

  /* âœ… Screen-only: pull the envelope preview up by 12px to remove the "double gap" look */
  margin-top: -12px;

  flex-wrap: nowrap;
}

.side{
  flex: 0 0 var(--side-width);
  width: var(--side-width);
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top: var(--s-3);

  height: 8.1in;
  max-height: 8.1in;
  overflow: hidden; /* prevent whole panel scroll */

  background: var(--card);
  border: 1px solid #e3e6eb;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-soft);
  padding: var(--s-3);
}

.side-title{
  font-family: var(--font-family);
  font-weight: var(--w-black);
  font-size: var(--fs-xs);
  letter-spacing:0.12em;
  text-align:center;
  margin-bottom:var(--s-3);
  color: #111;
}

/* Let the driver list use leftover space in the fixed-height card */
.driver-grid{
  flex: 1 1 auto;
  min-height: 0;   /* CRITICAL for scrolling inside flex */
}

/* Scroll ONLY the names */
#driverList{
  flex: 1 1 auto;  /* take remaining height */
  min-height: 0;   /* CRITICAL */
  overflow-y: auto;
  overflow-x: hidden;

  /* Optional: remove your max-height so it uses remaining space */
  max-height: none;
}

.driver-mode{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
  flex: 0 0 auto;
}

/* Active toggle hover should use PRIMARY hover colors */
.driver-mode .button-default.active:hover{
  background: linear-gradient(var(--btn-primary-hover-bg), var(--btn-primary-hover-bg2));
  border-color: var(--btn-primary-border);
  color: var(--btn-primary-text);
}

/* Toggle buttons: active should look like primary */
.driver-mode .button-default.active{
  background: linear-gradient(var(--btn-primary-bg), var(--btn-primary-bg2));
  border: 1.5px solid var(--btn-primary-border);
  color: var(--btn-primary-text);
  box-shadow: var(--shadow-soft);
}


.driver-mode .mode:focus{
  outline: none;
  box-shadow: 0 0 0 3px var(--focus), 0 1px 0 rgba(16,24,40,0.03);
  border-color: #7aa0ff;
}

#driverList{
  display: flex;
  flex-direction: column;
  gap: 8px;

  /* Set a max-height so it will scroll */
  max-height: auto; /* Adjust as needed for your layout */

  overflow-y: auto;
  overflow-x: hidden;

  padding-right: 2px;

  scrollbar-width: none;
  -ms-overflow-style: none;

  /* OPTIONAL: subtle scroll hint */
  mask-image: linear-gradient(
    to bottom,
    black 90%,
    transparent 100%
  );
}

/* All side buttons share the same base look */
.bus-btn,
.driver-btn{
  font-family: var(--font-family);
  font-size: var(--fs-sm);
  font-weight: var(--fw-bold);
  padding: 9px 11px;
  border: 1px solid #cfd6de;
  background: linear-gradient(#ffffff, #f5f7fa);
  border-radius: 10px;
  cursor:pointer;
  box-shadow: 0 1px 0 rgba(16,24,40,0.03);
  transition: background 120ms ease, border-color 120ms ease, transform 80ms ease;
  touch-action: manipulation;
}
.bus-btn:hover,
.driver-btn:hover{ background: linear-gradient(#ffffff, #eef2f6); }

.bus-btn:active,
.driver-btn:active{ transform: translateY(1px); }

.bus-btn:focus,
.driver-btn:focus{
  outline:none;
  box-shadow: 0 0 0 3px var(--focus), 0 1px 0 rgba(16,24,40,0.03);
  border-color: #7aa0ff;
}

/* Bus buttons use default button styling for consistency */
/* Color variants intentionally removed */

/* Selected states (keep behavior identical) */
.bus-btn.selected{
  background: linear-gradient(#1a1a1a, #000) !important;
  color:#fff !important;
  border-color:#111 !important;
  box-shadow: var(--shadow-soft);
}

.driver-btn.selected,
.driver-btn.selected-driver{
  background: linear-gradient(#1a1a1a, #000);
  color:#fff;
  border-color:#111;
  box-shadow: var(--shadow-soft);
}

.driver-btn.selected-codriver{
  background: linear-gradient(#4b5563, #374151);
  color:#fff;
  border-color:#374151;
  box-shadow: var(--shadow-soft);
}

/* ---------- Page (print artifact) â€” DO NOT CHANGE DIMENSIONS ---------- */
.page{
  width:5.8in;
  height:8.1in;
  padding: var(--pad);
  margin-top: var(--s-3);
  overflow:visible;
  position:relative;
  background: transparent;
}

.panel{
  width:100%;
  height:100%;
  padding: var(--panel-pad);
  padding-top: calc(var(--panel-pad) + 0.25in);
  padding-bottom: var(--panel-pad);
  display:flex;
  flex-direction:column;
  gap: var(--section-gap);
}

/* ===== Text (print) ===== */
.label,.tiny{
  font-family: var(--mono);
  font-weight:700;
  text-transform:uppercase;
  white-space:nowrap;
}
.label{
  font-size:var(--label-size);
  letter-spacing:0.12em;
}
.tiny{
  font-size:var(--tiny-size);
  letter-spacing:0.07em;
  opacity:.9;
}

/* ===== Inputs (print inputs unchanged) ===== */
input::placeholder{
  color:#8b1e1e;
  background:#fde8e8;
  font-style:bold;
  letter-spacing:0.04em;
  padding:0 2px;
  border-radius:2px;
}
#day::placeholder{
  color:#8b1e1e;
  background:#fde8e8;
  font-style:bold;
  letter-spacing:0.04em;
  padding:0 4px;
  border-radius:3px;
}
input.edit{
  font-family: var(--sans);
  font-weight:700;
  font-size: var(--input-size);
  border:none;
  background:transparent;
  width:100%;
  min-height:0.17in;
}
input.edit.under{ border-bottom: none; }
input:focus{ outline:none; }

/* ===== Header (print) ===== */
.header{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  gap:0.04in;
  margin-bottom: 0.06in;
}
#day{
  display:block;
  margin:0 auto;
  font-family: var(--mono);
  font-weight:900;
  font-size:0.46in;
  letter-spacing:0.03em;
  text-transform:uppercase;
  text-align:center;
}
.brand img{ height:0.42in; }
.brand .addr{
  font-family: var(--mono);
  font-size:0.11in;
  font-weight:800;
  line-height:1.2;
}

/* ===== Titles (print) ===== */
.section-title{
  text-align:center;
  font-weight:900;
  letter-spacing:0.14em;
  font-size:0.18in;
}

/* ===== Trip (print) ===== */
.trip{ border: none; }
.trip-row{
  display:grid;
  border-top: var(--border) solid var(--rule);
}
.trip-row:first-child{ border-top:none; }

.cols-3{ grid-template-columns:.9fr 1.25fr 1.1fr; }
.cols-2{ grid-template-columns:1.25fr 1fr; }
.cols-1{ grid-template-columns:1fr; }

.trip-cell{
  padding:0.045in .08in;
  border-left: var(--border) solid var(--rule);
  display:flex;
  flex-direction:column;
  gap:.03in;
}
.trip-cell:first-child{ border-left:none; }

/* Pickup */
.pickup-field{ display:flex; flex-direction:column; gap:.03in; }
.pickup-tag{
  background:var(--pickup);
  padding:.035in .055in;
  font-family:var(--mono);
  font-weight:900;
  font-size:var(--label-size);
  letter-spacing:.08em;
}

/* Trip + Contact wrapper */
.trip-contact{ border: var(--border) solid var(--rule); }
.trip{ border:none; }
.trip-contact .grid{ border:none; }

/* Contact grid */
.grid-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  border-top: var(--border) solid var(--rule);
}
.grid-row:first-child{ border-top:none; }

.grid-cell{
  padding:.045in .08in;
  border-left: var(--border) solid var(--rule);
  display:flex;
  flex-direction:column;
  gap:.03in;
}
.grid-cell:first-child{ border-left:none; }

.trip-contact .grid-row:first-child{
  border-top: var(--border) solid var(--rule);
}

/* Odometer */
.odometer-box{
  border: var(--border) solid var(--rule);
  margin-top: 0;
}

/* Expenses */
.mini{ border: none; }

.mini table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-family:var(--mono);
  border: var(--border) solid var(--rule);
}
.mini tr{ height:var(--exp-row-h); }
.mini td{
  border: var(--border) solid var(--rule);
  padding:.022in .07in;
  vertical-align:middle;
  font-size:.12in;
  line-height:1.05;
  white-space:nowrap;
  text-align: center;
}
.mini-td-left {
  text-align: left !important;
}

.money{
  display:flex;
  align-items:center;
  gap:.06in;
  width:100%;
}
.money .dollar{ font-weight:900; }
.money .amount-space{ flex:1; height:.16in; }

.notes{
  display:grid;
  grid-template-columns:.9in 1fr;
  gap:.08in;
}

.trip,
.grid,
.mini,
.footer{
  margin-left: 0;
  margin-right: 0;
}

.trip-contact,
.odometer-box,
.mini,
.footer{
  margin: 0;
}

.notes-lines{
  display:flex;
  flex-direction:column;
  gap:0.03in;
  margin-top:0.02in;
}

/* Make driver buttons look like default buttons */
.driver-btn{
  background: linear-gradient(var(--btn-default-bg), var(--btn-default-bg2));
  border: 1.5px solid var(--btn-default-border);
  color: var(--btn-default-text);

  border-radius: var(--radius-md);
  box-shadow: var(--shadow-soft);
  cursor: pointer;

  font-size: var(--fs-sm);
  font-weight: var(--fw-bold);
  padding: var(--s-2) var(--s-3);

  width: 100%;
  text-align: center;
  white-space: nowrap;

  transition: background 120ms, border-color 120ms, transform 80ms;
}

.driver-btn:hover{
  background: linear-gradient(var(--btn-default-hover-bg), var(--btn-default-hover-bg2));
  border-color: var(--btn-default-border);
}

.note-line{
  font-family: var(--mono);
  font-size: 0.13in;
  font-weight:700;
  height:0.16in;
  border:none;
  border-bottom: var(--underline);
  padding:0 0.02in;
}

/* Print bounds debug */
.show-bounds .page{
  outline: 2px dashed red;
  outline-offset: -2px;
}
.show-bounds .page::after{
  content:"";
  position:absolute;
  inset: 0.18in;
  border: 1px dotted blue;
  pointer-events:none;
}

/* Envelope preview */
.show-envelope .page{
  background: #e9cd86;
  background-image:
    radial-gradient(rgba(0,0,0,.035) 1px, transparent 1px),
    linear-gradient(0deg, rgba(255,255,255,.22), rgba(255,255,255,0));
  background-size: 6px 6px, 100% 100%;
}
.show-envelope .panel{ background: transparent; }

/* Envelope preview (white) */
.show-envelope-white .page {
  background: #fff !important;
  background-image: none !important;
}
.show-envelope-white .panel { background: transparent; }

.driver-mode .button-default.active{
  background: linear-gradient(var(--btn-primary-bg), var(--btn-primary-bg2));
  border: 1.5px solid var(--btn-primary-border);
  color: var(--btn-primary-text);
  box-shadow: var(--shadow-soft);
}

/* Print rules */
@media print{
  html, body{
    margin: 0 !important;
    padding: 0 !important;
    background:#fff;
    color:#000;
    font-family: var(--font-family);
  }

  /* Remove screen layout spacing that can push content onto a new sheet */
  .app{
    max-width: none !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .screen-only{ display:none !important; }
  .print-only{ display:block !important; }

  /* Center the single A5 page */
  .layout{
    padding:0 !important;
    gap:0 !important;
    display:flex !important;
    justify-content:center !important;
    align-items:flex-start !important;
  }

  .page{
    margin: 0 auto !important;
    page-break-inside: avoid;
    break-inside: avoid;
  }

  .controls,
  .side,
  .tool-header{
    display:none !important;
  }

  .show-bounds .page{ outline:none; }
  .show-bounds .page::after{ content:none; }

  .show-envelope .page{
    background: transparent !important;
  }
}

/* Fixed card stays fixed */
.side{
  height: 8.1in;
  max-height: 8.1in;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Make the wrapper and list able to shrink inside the fixed height */
.driver-grid{
  flex: 1 1 auto;
  min-height: 0;          /* CRITICAL */
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Scroll ONLY the names */
#driverList{
  flex: 1 1 auto;         /* take remaining space */
  min-height: 0;          /* CRITICAL */
  overflow-y: auto;       /* mouse wheel scroll */
  overflow-x: hidden;
}


  </style>
</head>
<body class="show-envelope">
    <!-- Progress Bar Overlay -->
    <div id="progress-bar-overlay" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.7);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
      <div style="width:320px;max-width:80vw;padding:32px 24px;background:#fff;border-radius:16px;box-shadow:0 4px 32px rgba(0,0,0,0.12);display:flex;flex-direction:column;align-items:center;">
        <div style="width:100%;height:18px;background:#e5e7eb;border-radius:8px;overflow:hidden;margin-bottom:16px;">
          <div id="progress-bar-inner" style="height:100%;width:0%;background:linear-gradient(90deg,#1a1a1a,#4b5563);transition:width 0.4s;"></div>
        </div>
        <span style="font-family:var(--font-family);font-weight:700;font-size:16px;color:#222;">Loading, please wait...</span>
      </div>
    </div>
  <div class="app">

    <header class="tool-header">
  <div class="tool-brand">
    <img src="logo.png" alt="Escamilla Tour Buses" class="tool-logo">
  </div>

  <div class="tool-title">
    <div class="name">TRIP ENVELOPE CREATOR</div>
  </div>

  <div class="tool-actions">
    <button class="button-default primary" type="button" onclick="loadFromSheet()">Load</button>
    <button class="button-default primary" type="button" onclick="saveToSheet()">Save</button>
    <button class="button-default danger" type="button" onclick="deleteEnvelope()" id="deleteEnvelopeBtn" disabled>Delete</button>
    <button class="button-default" type="button" onclick="clearAll()">Clear</button>
    <button class="button-default" type="button" onclick="safePrint()">Print</button>
    <button class="button-default" type="button" onclick="toggleEnvelope()">Yellow Env</button>
    <button class="button-default" type="button" onclick="toggleEnvelopeWhite()">White Env</button>
    <button class="button-default" type="button" onclick="goHome()">Home</button>
  </div>
</header>

<div class="quick-actions-box">

  <!-- Autofill -->
  <div class="quick-actions-section">
    <div class="quick-actions-label">Autofill</div>
    <div class="btn-row">
      <button class="button-default" type="button" onclick="loadAutofill1()">Kickapoo Trip</button>
    <button class="button-default" type="button" onclick="loadAutofill2()">Paragon Trip</button>
    <button class="button-default" type="button" onclick="loadAutofill5()">MVM Trip</button>
    </div>
  </div>

  <!-- Trip Date -->
  <div class="quick-actions-section">
    <div class="quick-actions-label">Trip Date</div>
    <div class="btn-row" style="align-items: center;">
      <input id="tripdate-picker" type="date" onchange="updateTripDate(this.value)" class="button-default" style="text-align: center;">
      <input id="returndate-picker" type="date" onchange="updateReturnDate(this.value)" class="button-default" style="text-align: center; margin-right: 8px;">

    </div>
  </div>

</div>

</div>
    </div>

    <div class="layout">

  <!-- LEFT: BUS LIST -->
<aside class="side side-left">
  <div class="side-title">BUSES</div>

  <button class="button-default" type="button" onclick="setBus('218', this)">218</button>
  <button class="button-default" type="button" onclick="setBus('763', this)">763</button>

  <button class="button-default" type="button" onclick="setBus('470', this)">470</button>
  <button class="button-default" type="button" onclick="setBus('133', this)">133</button>
  <button class="button-default" type="button" onclick="setBus('506', this)">506</button>

  <button class="button-default" type="button" onclick="setBus('746', this)">746</button>
  <button class="button-default" type="button" onclick="setBus('607', this)">607</button>

  <button class="button-default" type="button" onclick="setBus('897', this)">897</button>
  <button class="button-default" type="button" onclick="setBus('898', this)">898</button>

  <button class="button-default" type="button" onclick="setBus('474', this)">474</button>
</aside>

  <div class="page">
  <div class="panel">

  <div class="header">
    <input id="day" class="edit" placeholder="ENTER DAY">
    <div class="brand">
      <img src="logo.png" alt="Logo">
      <div class="addr">
        2801 Zinnia Ave. McAllen TX 78504<br>
        (956) 994-1169 / Fax 994-9491 / Cell 648-9691
      </div>
    </div>
  </div>

  <div class="section-title">TRIP INFORMATION</div>

<div class="trip-contact">
  <div class="trip">
    <!-- BUS/DRIVER/CO-DRIVER row -->
    <div class="trip-row cols-3">
  <div class="trip-cell">
    <span class="label">BUS #</span>
    <input id="busno" class="edit under" placeholder="CHOOSE BUS">
  </div>
  <div class="trip-cell">
    <span class="label">BUS DRIVER</span>
    <input id="driver" class="edit under" placeholder="ASSIGN DRIVER">
  </div>
  <div class="trip-cell">
    <span class="label">CO-DRIVER</span>
    <input id="codriver" class="edit under">
  </div>
</div>

    <!-- DATE/TIME row -->
    <div class="trip-row cols-2">
      <div class="trip-cell">
        <div style="display: flex; justify-content: space-between; align-items: baseline; width: 100%;">
          <span class="label">TRIP DATE</span>
          <span class="label" style="text-align:right;">RETURN</span>
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 0.08in;
          "
        >
          <input
            id="tripdate"
            class="edit under"
            placeholder="CHOOSE DATE"
            style="text-align:left; width:120px; min-width:unset; max-width:unset;"
            oninput="updateHyphenVisibility()"
          >
          <span style="flex:1 1 auto;"></span>
          <input
            id="returndate"
            class="edit under"
            style="text-align:right; width:120px; min-width:unset; max-width:unset;"
            oninput="updateHyphenVisibility()"
          >
        </div>
      </div>
      <div class="trip-cell">
        <span class="label">ARRIVAL TIME</span>
        <input id="arrivaltime" class="edit under" placeholder="ENTER ARRIVAL TIME">
      </div>
    </div>

    <!-- PICKUP -->
    <div class="trip-row cols-1">
      <div class="trip-cell"><span class="label">PICK UP ADDRESS</span><input id="pickup" class="edit under" placeholder="ENTER PICKUP ADDRESS">
</div>
    </div>

    <!-- DESTINATION -->
    <div class="trip-row cols-1">
      <div class="trip-cell"><span class="label">DESTINATION</span><input id="destination" class="edit under" placeholder="ENTER DESTINATION">
</div>
    </div>
  </div>

  <div class="grid">
    <div class="grid-row">
      <div class="grid-cell"><span class="label">CONTACT</span><input id="contact" class="edit under" placeholder="ENTER CONTACT NAME">
</div>
      <div class="grid-cell"><span class="label">PHONE</span><input id="phone" class="edit under" placeholder="ENTER PHONE #">
</div>
    </div>
  </div>
</div>

<!-- Separate ODOMETER box -->
<div class="grid odometer-box">
  <div class="grid-row">
    <div class="grid-cell"><span class="label">STARTING ODOMETER</span><input id="startodo" class="edit under"></div>
    <div class="grid-cell"><span class="label">ENDING ODOMETER</span><input id="endodo" class="edit under"></div>
  </div>
</div>

  <div class="mini">
  <table>
    <tr>
      <td>ELD BACKUP USED</td><td>YES / NO</td><td>DIESEL/BLUE DEF</td>
      <td><div class="money"><span class="dollar">$</span><span class="amount-space"></span></div></td>
    </tr>
    <tr>
      <td>ELD VERIFIED</td><td>DRIVER / OFFICE</td><td>HOTEL</td>
      <td><div class="money"><span class="dollar">$</span><span class="amount-space"></span></div></td>
    </tr>
    <tr>
      <td>CC FOR TRIP</td><td>YES / NO</td><td>REPAIRS</td>
      <td><div class="money"><span class="dollar">$</span><span class="amount-space"></span></div></td>
    </tr>
    <tr>
      <td colspan="2" class="mini-td-left">CC RECEIVED BY</td><td>MISCELLANEOUS</td>
      <td><div class="money"><span class="dollar">$</span><span class="amount-space"></span></div></td>
    </tr>
    <tr>
      <td colspan="2" class="mini-td-left">TOTAL TRIP MILES</td><td>TOTAL</td>
      <td><div class="money"><span class="dollar">$</span><span class="amount-space"></span></div></td>
    </tr>
  </table>
  </div>

  <div class="footer">
    <span class="label">NOTES</span>
    <div class="notes-lines">
      <input class="edit note-line" id="notes1">
      <input class="edit note-line" id="notes2">
      <input class="edit note-line" id="notes3">
    </div>
  </div>

  </div>
  </div>

<!-- RIGHT: DRIVER LIST -->
<aside class="side side-right">
  <div class="side-title">DRIVERS</div>

  <div class="driver-grid">

    <div class="driver-mode">
      <button type="button" id="fillDriverBtn" class="button-default active" onclick="setDriverMode('driver')">Driver</button>
      <button type="button" id="fillCoDriverBtn" class="button-default" onclick="setDriverMode('codriver')">Co-Driver</button>
    </div>

    <div id="driverList">
      <button class="driver-btn" type="button" onclick="setDriver('George')">George</button>
      <button class="driver-btn" type="button" onclick="setDriver('Isaias')">Isaias</button>
      <button class="driver-btn" type="button" onclick="setDriver('Jorge')">Jorge</button>
      <button class="driver-btn" type="button" onclick="setDriver('Raul')">Raul</button>
      <button class="driver-btn" type="button" onclick="setDriver('Veronica')">Veronica</button>
      <button class="driver-btn" type="button" onclick="setDriver('Andy')">Andy</button>
      <button class="driver-btn" type="button" onclick="setDriver('Arredondo')">Arredondo</button>
      <button class="driver-btn" type="button" onclick="setDriver('Cortinas')">Cortinas</button>
      <button class="driver-btn" type="button" onclick="setDriver('David')">David</button>
      <button class="driver-btn" type="button" onclick="setDriver('Felipe')">Felipe</button>
      <button class="driver-btn" type="button" onclick="setDriver('Guillermo')">Guillermo</button>
      <button class="driver-btn" type="button" onclick="setDriver('Maria')">Maria</button>
      <button class="driver-btn" type="button" onclick="setDriver('Martinez')">Martinez</button>
      <button class="driver-btn" type="button" onclick="setDriver('Noe')">Noe</button>
      <button class="driver-btn" type="button" onclick="setDriver('Oscar')">Oscar</button>
      <button class="driver-btn" type="button" onclick="setDriver('Prudenciano')">Prudenciano</button>
      <button class="driver-btn" type="button" onclick="setDriver('Rigo')">Rigo</button>
      <button class="driver-btn" type="button" onclick="setDriver('Salim')">Salim</button>
      <button class="driver-btn" type="button" onclick="setDriver('Sanchez')">Sanchez</button>
      <button class="driver-btn" type="button" onclick="setDriver('Agustin')">Agustin</button>
      <button class="driver-btn" type="button" onclick="setDriver('Benny')">Benny</button>
      <button class="driver-btn" type="button" onclick="setDriver('Garza')">Garza</button>
      <button class="driver-btn" type="button" onclick="setDriver('Griselda')">Griselda</button>
      <button class="driver-btn" type="button" onclick="setDriver('Ivan')">Ivan</button>
      <button class="driver-btn" type="button" onclick="setDriver('Jay')">Jay</button>
      <button class="driver-btn" type="button" onclick="setDriver('Jonathan')">Jonathan</button>
      <button class="driver-btn" type="button" onclick="setDriver('Jose')">Jose</button>
      <button class="driver-btn" type="button" onclick="setDriver('Juan')">Juan</button>
      <button class="driver-btn" type="button" onclick="setDriver('Julie')">Julie</button>
      <button class="driver-btn" type="button" onclick="setDriver('Miguel')">Miguel</button>
      <button class="driver-btn" type="button" onclick="setDriver('Hector')">Hector</button>
      <button class="driver-btn" type="button" onclick="setDriver('Jose P')">Jose P</button>
    </div>

  </div>
</aside>

</div>

<script>
function setBus(busNo, btn){
  const busEl = document.getElementById('busno');
  if(busEl) busEl.value = busNo;

  document.querySelectorAll('.bus-btn')
    .forEach(b => b.classList.remove('selected'));

  if(btn) btn.classList.add('selected');
}

let driverFillTarget = 'driver';

function setDriverMode(target){
  driverFillTarget = target;

  const d = document.getElementById('fillDriverBtn');
  const c = document.getElementById('fillCoDriverBtn');
  if(d && c){
    d.classList.toggle('active', target === 'driver');
    c.classList.toggle('active', target === 'codriver');
  }
}

function setDriver(name){
  const targetEl = document.getElementById(driverFillTarget);
  if(targetEl) targetEl.value = name.toUpperCase();

}

function fillToday(){
  const dayEl = document.getElementById('day');
  const dateEl = document.getElementById('tripdate');

  const today = new Date();

  if(dayEl){
    dayEl.value = today.toLocaleDateString(undefined, { weekday: 'long' }).toUpperCase();
  }

  if(dateEl){
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const yyyy = today.getFullYear();
    dateEl.value = `${mm}/${dd}/${yyyy}`;
  }
}

function fillTomorrow(){
  const dayEl = document.getElementById('day');
  const dateEl = document.getElementById('tripdate');

  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);

  if(dayEl){
    dayEl.value = tomorrow.toLocaleDateString(undefined, { weekday: 'long' }).toUpperCase();
  }

  if(dateEl){
    const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
    const dd = String(tomorrow.getDate()).padStart(2, '0');
    const yyyy = tomorrow.getFullYear();
    dateEl.value = `${mm}/${dd}/${yyyy}`;
  }
}

function fillNextWeekday(targetDow){
  const dayEl = document.getElementById('day');
  const dateEl = document.getElementById('tripdate');

  const d = new Date();
  const todayDow = d.getDay();

  let add = (targetDow - todayDow + 7) % 7;
  if(add === 0) add = 7;

  d.setDate(d.getDate() + add);

  if(dayEl){
    dayEl.value = d.toLocaleDateString(undefined, { weekday: 'long' }).toUpperCase();
  }

  if(dateEl){
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const yyyy = d.getFullYear();
    dateEl.value = `${mm}/${dd}/${yyyy}`;
  }
}

function loadSample(){
  document.querySelectorAll('.sample-fill')
    .forEach(el => el.classList.remove('sample-fill'));

  const arrival = document.getElementById('arrivaltime');
  arrival.value = '4:30 AM';
  arrival.classList.add('sample-fill');

  const pickup = document.getElementById('pickup');
  pickup.value = '2801 ZINNIA AVE, MCALLEN, TX 78504';
  pickup.classList.add('sample-fill');

  const dest = document.getElementById('destination');
  dest.value = 'KICKAPOO CASINO 794 LUCKY EAGLE DR, EAGLE PASS, TX 78852';
  dest.classList.add('sample-fill');

  const contact = document.getElementById('contact');
  contact.value = 'HECTOR ESCAMILLA';
  contact.classList.add('sample-fill');

  const phone = document.getElementById('phone');
  phone.value = '(956) 994-1169';
  phone.classList.add('sample-fill');
}

function loadAutofill1(){
  document.querySelectorAll('.sample-fill')
    .forEach(el => el.classList.remove('sample-fill'));

  const arrival = document.getElementById('arrivaltime');
  if(arrival){
    arrival.value = '4:30 AM';
    arrival.classList.add('sample-fill');
  }

  const pickup = document.getElementById('pickup');
  if(pickup){
    pickup.value = '2801 ZINNIA AVE, MCALLEN, TX 78504';
    pickup.classList.add('sample-fill');
  }

  const dest = document.getElementById('destination');
  if(dest){
    dest.value = 'KICKAPOO CASINO 794 LUCKY EAGLE DR, EAGLE PASS, TX 78852';
    dest.classList.add('sample-fill');
  }

  const contact = document.getElementById('contact');
  if(contact){
    contact.value = 'HECTOR ESCAMILLA';
    contact.classList.add('sample-fill');
  }

  const phone = document.getElementById('phone');
  if(phone){
    phone.value = '(956) 994-1169';
    phone.classList.add('sample-fill');
  }
}

/* Autofill 2 â€” example trip (edit values later) */
function loadAutofill2(){
  document.querySelectorAll('.sample-fill')
    .forEach(el => el.classList.remove('sample-fill'));

  const arrival = document.getElementById('arrivaltime');
  if(arrival){
    arrival.value = '4:30 AM';
    arrival.classList.add('sample-fill');
  }

  const pickup = document.getElementById('pickup');
  if(pickup){
    pickup.value = '2801 ZINNIA AVE, MCALLEN, TX 78504';
    pickup.classList.add('sample-fill');
  }

  const dest = document.getElementById('destination');
  if(dest){
    dest.value = 'PARAGON CASINO 711 PARAGON PL, MARKSVILLE, LA 71351';
    dest.classList.add('sample-fill');
  }

  const contact = document.getElementById('contact');
  if(contact){
    contact.value = 'ASHLEY PEARL';
    contact.classList.add('sample-fill');
  }

  const phone = document.getElementById('phone');
  if(phone){
    phone.value = '(956) 994-1169';
    phone.classList.add('sample-fill');
  }
}
/* Autofill 3 â€” example trip (edit values later) */
function loadAutofill3(){
  document.querySelectorAll('.sample-fill')
    .forEach(el => el.classList.remove('sample-fill'));

  const arrival = document.getElementById('arrivaltime');
  if(arrival){
    arrival.value = '10:00 AM';
    arrival.classList.add('sample-fill');
  }

  const pickup = document.getElementById('pickup');
  if(pickup){
    pickup.value = 'MCALLEN, TX (ENTER PICKUP ADDRESS)';
    pickup.classList.add('sample-fill');
  }

  const dest = document.getElementById('destination');
  if(dest){
    dest.value = 'AUSTIN, TX (ENTER DESTINATION)';
    dest.classList.add('sample-fill');
  }

  const contact = document.getElementById('contact');
  if(contact){
    contact.value = 'DISPATCH (ENTER CONTACT)';
    contact.classList.add('sample-fill');
  }

  const phone = document.getElementById('phone');
  if(phone){
    phone.value = '(956) 000-0000';
    phone.classList.add('sample-fill');
  }
}

/* Autofill 4 â€” example trip (edit values later) */
function loadAutofill4(){
  document.querySelectorAll('.sample-fill')
    .forEach(el => el.classList.remove('sample-fill'));

  const arrival = document.getElementById('arrivaltime');
  if(arrival){
    arrival.value = '6:00 PM';
    arrival.classList.add('sample-fill');
  }

  const pickup = document.getElementById('pickup');
  if(pickup){
    pickup.value = 'MCALLEN, TX (ENTER PICKUP ADDRESS)';
    pickup.classList.add('sample-fill');
  }

  const dest = document.getElementById('destination');
  if(dest){
    dest.value = 'DALLAS, TX (ENTER DESTINATION)';
    dest.classList.add('sample-fill');
  }

  const contact = document.getElementById('contact');
  if(contact){
    contact.value = 'DISPATCH (ENTER CONTACT)';
    contact.classList.add('sample-fill');
  }

  const phone = document.getElementById('phone');
  if(phone){
    phone.value = '(956) 000-0000';
    phone.classList.add('sample-fill');
  }
}
/* Autofill 5 â€” Pickup + Contact only */
function loadAutofill5(){
  document.querySelectorAll('.sample-fill')
    .forEach(el => el.classList.remove('sample-fill'));

  const pickup = document.getElementById('pickup');
  if(pickup){
    pickup.value = 'MVM 220 S K CENTER ST, MCALLEN, TX 78501';
    pickup.classList.add('sample-fill');
  }

  const contact = document.getElementById('contact');
  if(contact){
    contact.value = 'ESCAMILLA TOUR BUSES';
    contact.classList.add('sample-fill');
  }

  const phone = document.getElementById('phone');
  if(phone){
    phone.value = '(956) 648-9691';
    phone.classList.add('sample-fill');
  }
}

function clearAll(){
  document.querySelectorAll('input').forEach(i=>{
    i.value = '';
    i.classList.remove('sample-fill');
  });
  loadedEnvelopeID = null; // Clear loaded envelope tracking
  updateDeleteButtonState();
}

// Enable/disable Delete button based on loadedEnvelopeID
function updateDeleteButtonState() {
  var btn = document.getElementById('deleteEnvelopeBtn');
  if (btn) {
    btn.disabled = !loadedEnvelopeID;
  }
}

// Delete envelope function
function deleteEnvelope() {
  if (!loadedEnvelopeID) {
    alert('No envelope loaded to delete.');
    return;
  }
  if (!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE') {
    alert('âš ï¸ Google Apps Script URL not configured.');
    return;
  }
  if (!confirm('Are you sure you want to delete this envelope? This cannot be undone.')) {
    return;
  }
  showProgressBar();
  fetch(GOOGLE_APPS_SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'envelope_delete',
      envelopeID: loadedEnvelopeID
    })
  })
    .then(response => response.json())
    .then(data => {
      hideProgressBar();
      if (data.ok) {
        alert('âœ… Envelope deleted successfully!');
        clearAll();
        updateDeleteButtonState();
      } else {
        alert('âŒ Error deleting envelope: ' + (data.error || data.message || 'Unknown error'));
      }
    })
    .catch(error => {
      hideProgressBar();
      alert('âŒ Error deleting from sheet:\n' + error);
    });
}

function toggleBounds(){
  document.body.classList.toggle('show-bounds');
}


function toggleEnvelope(){
  // Remove white preview if active
  document.body.classList.remove('show-envelope-white');
  document.body.classList.toggle('show-envelope');
}

function toggleEnvelopeWhite(){
  // Remove yellow preview if active
  document.body.classList.remove('show-envelope');
  document.body.classList.toggle('show-envelope-white');
}

function safePrint(){
  const requiredIds = [
    'day','tripdate','busno','driver',
    'arrivaltime','pickup','destination','contact','phone'
  ];

  const missing = requiredIds.filter(id=>{
    const el = document.getElementById(id);
    return !el || !el.value.trim();
  });

  if(missing.length){
    alert(
      "âš ï¸ Missing required fields.\n\n" +
      "Fill in all red-placeholder fields before printing."
    );
    return;
  }

  window.print();
}

// Google Sheets Integration
// Replace this URL with your Google Apps Script deployment URL
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywdzzwTUpP_Mkw3BLRTSxLsStJuzeSNI-4zbeIXSZcjirB5-dhHpOXDc0fUVfoZHrk/exec'; // Same URL as your existing Trips API

// Track currently loaded envelope for updates
let loadedEnvelopeID = null;

function saveToSheet(){
  const requiredIds = [
    'day','tripdate','busno','driver',
    'arrivaltime','pickup','destination','contact','phone'
  ];

  const missing = requiredIds.filter(id=>{
    const el = document.getElementById(id);
    return !el || !el.value.trim();
  });

  if(missing.length){
    alert(
      "âš ï¸ Missing required fields.\n\n" +
      "Fill in all red-placeholder fields before saving."
    );
    return;
  }

  if(!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE'){
    alert('âš ï¸ Google Apps Script URL not configured.\n\nPlease follow the setup instructions.');
    return;
  }

  // Collect form data
  const rowData = {
    day: document.getElementById('day').value,
    tripdate: document.getElementById('tripdate').value,
    returndate: document.getElementById('returndate') ? document.getElementById('returndate').value : '',
    busno: document.getElementById('busno').value,
    driver: document.getElementById('driver').value,
    codriver: document.getElementById('codriver').value,
    arrivaltime: document.getElementById('arrivaltime').value,
    pickup: document.getElementById('pickup').value,
    destination: document.getElementById('destination').value,
    contact: document.getElementById('contact').value,
    phone: document.getElementById('phone').value,
    startodo: document.getElementById('startodo').value,
    endodo: document.getElementById('endodo').value,
    notes1: document.getElementById('notes1').value,
    notes2: document.getElementById('notes2').value,
    notes3: document.getElementById('notes3').value
  };

  // Determine if this is an update or new save
  const formData = {
    action: loadedEnvelopeID ? "envelope_update" : "envelope_save",
    row: rowData
  };

  // If updating, include the envelope ID to identify the row
  if(loadedEnvelopeID){
    formData.envelopeID = loadedEnvelopeID;
  }

  // Send to Google Sheet
  showProgressBar();
  fetch(GOOGLE_APPS_SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify(formData)
  })
  .then(response => response.json())
  .then(data => {
    hideProgressBar();
    if(data.ok){
      const message = data.mode === 'envelope_updated' ? 'âœ… Envelope updated successfully!' : 'âœ… Envelope saved successfully!';
      alert(message);
      if(data.envelopeID){
        loadedEnvelopeID = data.envelopeID;
      }
    } else {
      alert('âŒ Error: ' + (data.error || data.message || 'Unknown error'));
    }
  })
  .catch(error => {
    hideProgressBar();
    alert('âŒ Error saving to sheet:\n' + error);
  });
}

function loadFromSheet(){
  if(!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL === 'YOUR_APPS_SCRIPT_DEPLOYMENT_URL_HERE'){
    alert('âš ï¸ Google Apps Script URL not configured.');
    return;
  }
  showProgressBar();
  fetch(GOOGLE_APPS_SCRIPT_URL + '?action=envelopes')
  .then(response => response.json())
  .then(data => {
    hideProgressBar();
    if(!data.ok || !data.rows || data.rows.length === 0){
      alert('No saved envelopes found.');
      return;
    }
    showEnvelopeSelectModal(data.rows);
  })
  .catch(error => {
    hideProgressBar();
    alert('âŒ Error loading from sheet:\n' + error);
  });
}

// Modal for envelope selection
function showEnvelopeSelectModal(envelopes) {
  // Remove existing modal if present
  const old = document.getElementById('envelope-select-modal');
  if (old) old.remove();

  // Sort envelopes by date (soonest first)
  function getDate(row) {
    const dateRaw = row['Trip Date'] || row['tripdate'] || row['Date'] || '';
    if (!dateRaw) return new Date(8640000000000000); // far future
    let d = new Date(dateRaw);
    if (isNaN(d.getTime()) && typeof dateRaw === 'string' && dateRaw.includes('T')) {
      d = new Date(dateRaw.split('T')[0]);
    }
    return isNaN(d.getTime()) ? new Date(8640000000000000) : d;
  }
  envelopes = envelopes.slice().sort((a, b) => getDate(a) - getDate(b));

  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.id = 'envelope-select-modal';
  overlay.style.position = 'fixed';
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = '100vw';
  overlay.style.height = '100vh';
  overlay.style.background = 'rgba(0,0,0,0.25)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = 10000;

  // Modal box
  const modal = document.createElement('div');
  modal.style.background = '#fff';
  modal.style.borderRadius = '14px';
  modal.style.boxShadow = '0 8px 32px rgba(0,0,0,0.18)';
  modal.style.padding = '32px 24px 24px 24px';
  modal.style.minWidth = '320px';
  modal.style.maxWidth = '90vw';
  modal.style.maxHeight = '80vh';
  modal.style.overflow = 'auto';

  // Title
  const title = document.createElement('div');
  title.textContent = 'Select an envelope to load';
  title.style.fontFamily = 'var(--font-family)';
  title.style.fontWeight = '900';
  title.style.fontSize = '18px';
  title.style.marginBottom = '18px';
  modal.appendChild(title);

  // Search box
  const search = document.createElement('input');
  search.type = 'text';
  search.placeholder = 'Search by date, bus, driver...';
  search.style.width = '100%';
  search.style.fontSize = '15px';
  search.style.padding = '8px 10px';
  search.style.marginBottom = '14px';
  search.style.border = '1px solid #d9dde3';
  search.style.borderRadius = '8px';
  modal.appendChild(search);

  // Dropdown
  const select = document.createElement('select');
  select.size = 8;
  select.style.width = '100%';
  select.style.fontSize = '15px';
  select.style.fontFamily = 'Motiva Sans, IBM Plex Sans, Arial, Helvetica, sans-serif';
  select.style.letterSpacing = '0.5px';
  select.style.padding = '6px 0';
  select.style.marginBottom = '18px';
  select.style.border = '1px solid #d9dde3';
  select.style.borderRadius = '8px';
  select.style.background = '#f7f9fc';
  select.style.cursor = 'pointer';

  function envelopeLabel(row) {
    const dateRaw = row['Trip Date'] || row['tripdate'] || row['Date'] || '';
    let dayText = '?';
    let tripDateStr = '?';
    if (dateRaw) {
      let d = new Date(dateRaw);
      if (isNaN(d.getTime()) && typeof dateRaw === 'string' && dateRaw.includes('T')) {
        d = new Date(dateRaw.split('T')[0]);
      }
      if (!isNaN(d.getTime())) {
        // Abbreviated weekday (MON, TUE, etc.)
        const weekday = d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
        dayText = weekday;
        tripDateStr = d.toISOString().slice(0, 10);
      }
    }
    const bus = (row['Bus #'] || row['busno'] || row['Bus'] || row['bus'] || row['Bus Number'] || row['bus_number'] || '?').toString();
    const driver = (row['Driver'] || row['driver'] || row['Driver Name'] || row['drivername'] || row['DriverName'] || row['driver_name'] || '?').toString();
    // Pad fields for symmetry: DAY(3) DATE(10) BUS(5) DRIVER(10)
    const pad = (str, len) => (str + ' '.repeat(len)).slice(0, len);
    return `${pad(dayText,3)} ${pad(tripDateStr,10)}  ${pad(bus,5)}  ${pad(driver,10)}`;
  }

  let filtered = envelopes.slice();
  function renderOptions() {
    select.innerHTML = '';
    filtered.forEach((row, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = envelopeLabel(row);
      select.appendChild(opt);
    });
  }
  renderOptions();

  search.addEventListener('input', function() {
    const q = search.value.trim().toLowerCase();
    filtered = envelopes.filter(row => envelopeLabel(row).toLowerCase().includes(q));
    renderOptions();
  });

  modal.appendChild(select);

  // Action buttons
  const btnRow = document.createElement('div');
  btnRow.style.display = 'flex';
  btnRow.style.justifyContent = 'flex-end';
  btnRow.style.gap = '10px';

  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = 'btn';
  cancelBtn.onclick = () => overlay.remove();
  btnRow.appendChild(cancelBtn);

  const loadBtn = document.createElement('button');
  loadBtn.textContent = 'Load';
  loadBtn.className = 'btn primary';
  loadBtn.disabled = select.selectedIndex === -1;
  loadBtn.onclick = () => {
    if (select.selectedIndex === -1) return;
    const envelope = filtered[select.selectedIndex];
    overlay.remove();
    fillEnvelopeFields(envelope);
  };
  btnRow.appendChild(loadBtn);

  select.addEventListener('change', () => {
    loadBtn.disabled = select.selectedIndex === -1;
  });

  modal.appendChild(btnRow);
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

function fillEnvelopeFields(envelope) {
  function formatDate(val) {
    if (!val) return '';
    if (typeof val === 'string' && val.includes('/')) return val;
    const d = new Date(val);
    if (isNaN(d.getTime())) return val;
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }
  function formatTime(val) {
    if (!val) return '';
    if (typeof val === 'string' && !val.includes('T')) return val;
    const d = new Date(val);
    if (isNaN(d.getTime())) return val;
    let hours = d.getHours();
    const minutes = String(d.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;
    return `${hours}:${minutes} ${ampm}`;
  }
  document.getElementById('day').value = envelope['Day'] || '';
  document.getElementById('tripdate').value = formatDate(envelope['Trip Date']);
  if(document.getElementById('returndate')){
    document.getElementById('returndate').value = formatDate(envelope['Return Date'] || envelope['returndate'] || '');
  }
  document.getElementById('busno').value = envelope['Bus #'] || '';
  document.getElementById('driver').value = envelope['Driver'] || '';
  document.getElementById('codriver').value = envelope['Co-Driver'] || '';
  document.getElementById('arrivaltime').value = formatTime(envelope['Arrival Time']);
  document.getElementById('pickup').value = envelope['Pickup'] || '';
  document.getElementById('destination').value = envelope['Destination'] || '';
  document.getElementById('contact').value = envelope['Contact'] || '';
  document.getElementById('phone').value = envelope['Phone'] || '';
  document.getElementById('startodo').value = envelope['Starting Odometer'] || '';
  document.getElementById('endodo').value = envelope['Ending Odometer'] || '';
  document.getElementById('notes1').value = envelope['Notes 1'] || '';
  document.getElementById('notes2').value = envelope['Notes 2'] || '';
  document.getElementById('notes3').value = envelope['Notes 3'] || '';
  loadedEnvelopeID = envelope['Envelope ID'] || envelope['Envelope Id'] || envelope['envelopeID'] || envelope['envelopeId'] || null;
  updateDeleteButtonState();
  alert('âœ… Envelope loaded successfully!');
}

function sortDriversAlphabetically(){
  const container = document.getElementById('driverList');
  if(!container) return;

  const buttons = Array.from(container.querySelectorAll('.driver-btn'));

  buttons.sort((a, b) =>
    a.innerText.trim().localeCompare(b.innerText.trim(), undefined, { sensitivity: 'base' })
  );

  buttons.forEach(btn => container.appendChild(btn));
}

window.addEventListener('DOMContentLoaded', function() {
  sortDriversAlphabetically();

  // Keep "day" in sync with tripdate field (manual edits)
  var tripDateInput = document.getElementById('tripdate');
  if (tripDateInput) {
    tripDateInput.addEventListener('change', function() {
      syncDayWithTripDate(tripDateInput.value);
    });
    tripDateInput.addEventListener('input', function() {
      syncDayWithTripDate(tripDateInput.value);
    });
  }

  var arrival = document.getElementById('arrivaltime');
  if (arrival) {
    arrival.addEventListener('input', updateHyphenVisibility);
    arrival.addEventListener('change', updateHyphenVisibility);
  }
  var tripdate = document.getElementById('tripdate');
  var returndate = document.getElementById('returndate');
  if (tripdate) {
    tripdate.addEventListener('input', updateHyphenVisibility);
    tripdate.addEventListener('change', updateHyphenVisibility);
  }
  if (returndate) {
    returndate.addEventListener('input', updateHyphenVisibility);
    returndate.addEventListener('change', updateHyphenVisibility);
  }
  updateHyphenVisibility();
});

// Helper to sync "day" field with tripdate value
function syncDayWithTripDate(date) {
  const dayField = document.getElementById('day');
  if (dayField && date) {
    // Accept both MM/DD/YYYY and YYYY-MM-DD
    let d;
    if (typeof date === 'string' && date.includes('/')) {
      // MM/DD/YYYY
      const parts = date.split('/');
      if (parts.length === 3) {
        d = new Date(Number(parts[2]), Number(parts[0]) - 1, Number(parts[1]));
      }
    } else if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
      // YYYY-MM-DD (force UTC to avoid timezone offset issues)
      const [year, month, day] = date.split('-');
      d = new Date(Date.UTC(Number(year), Number(month) - 1, Number(day)));
      // Use local time for weekday calculation
      d = new Date(Number(year), Number(month) - 1, Number(day));
    } else {
      d = new Date(date);
    }
    if (!isNaN(d.getTime())) {
      const weekday = d.toLocaleDateString(undefined, { weekday: 'long' });
      dayField.value = weekday.charAt(0).toUpperCase() + weekday.slice(1).toLowerCase();
    }
  }
}

function updateTripDate(date) {
  const tripDateField = document.getElementById('tripdate');
  if (tripDateField && date) {
    // Convert YYYY-MM-DD to MM/DD/YYYY
    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
      const [year, month, day] = date.split('-');
      tripDateField.value = `${month}/${day}/${year}`;
    } else {
      tripDateField.value = date;
    }
    syncDayWithTripDate(tripDateField.value);
  }
}

function updateReturnDate(date) {
  const returnDateField = document.getElementById('returndate');
  if (returnDateField && date) {
    // Convert YYYY-MM-DD to MM/DD/YYYY
    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
      const [year, month, day] = date.split('-');
      returnDateField.value = `${month}/${day}/${year}`;
    } else {
      returnDateField.value = date;
    }
  }
}

function updateHyphenVisibility() {
  var hyphen = document.getElementById('date-hyphen');
  var tripdate = document.getElementById('tripdate');
  var returndate = document.getElementById('returndate');
  if (hyphen) {
    if (
      tripdate && returndate &&
      tripdate.value.trim() !== '' &&
      returndate.value.trim() !== ''
    ) {
      hyphen.style.visibility = 'visible';
    } else {
      hyphen.style.visibility = 'hidden';
    }
  }
}


function goHome() {
  window.location.href = "https://hellorux.github.io/etb_homepage/";
}
</script>

<!-- Progress Bar JS -->
<script>
function showProgressBar() {
  var overlay = document.getElementById('progress-bar-overlay');
  var bar = document.getElementById('progress-bar-inner');
  if (overlay && bar) {
    overlay.style.display = 'flex';
    bar.style.width = '0%';
    // Animate to 80% quickly, then slowly to 95%
    setTimeout(function() { bar.style.width = '80%'; }, 100);
    setTimeout(function() { bar.style.width = '95%'; }, 1200);
  }
}
function hideProgressBar() {
  var overlay = document.getElementById('progress-bar-overlay');
  var bar = document.getElementById('progress-bar-inner');
  if (overlay && bar) {
    bar.style.width = '100%';
    setTimeout(function() { overlay.style.display = 'none'; bar.style.width = '0%'; }, 400);
  }
}
</script>

</body>
</html>
